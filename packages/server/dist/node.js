"use strict";var g=Object.create;var l=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var v=Object.getPrototypeOf,P=Object.prototype.hasOwnProperty;var k=(e,t)=>{for(var n in t)l(e,n,{get:t[n],enumerable:!0})},y=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of A(t))!P.call(e,o)&&o!==n&&l(e,o,{get:()=>t[o],enumerable:!(r=q(t,o))||r.enumerable});return e};var H=(e,t,n)=>(n=e!=null?g(v(e)):{},y(t||!e||!e.__esModule?l(n,"default",{value:e,enumerable:!0}):n,e)),b=e=>y(l({},"__esModule",{value:!0}),e);var I={};k(I,{createHandler:()=>d,createHttpHandler:()=>R,createMiddleware:()=>j,nodeAdapter:()=>f,serve:()=>M});module.exports=b(I);function d(e,t){return async(n,r)=>{let o=await e.toRequest(n),s=await t(o);return e.toResponse(s,r)}}var f={name:"node",async toRequest(e){let t=e,n=t.url||"/",r=t.method||"GET",o={};for(let[u,c]of Object.entries(t.headers))typeof c=="string"?o[u.toLowerCase()]=c:Array.isArray(c)&&(o[u.toLowerCase()]=c.join(", "));let s;["POST","PUT","PATCH"].includes(r)&&(s=await S(t));let i=t.socket?.encrypted?"https":"http",a=o.host||"localhost";return{url:`${i}://${a}${n}`,method:r,headers:o,body:s}},toResponse(e,t){let n=t;n.statusCode=e.status;for(let[r,o]of Object.entries(e.headers))n.setHeader(r,o);return typeof e.body=="string"?n.end(e.body):e.body instanceof ReadableStream?x(e.body,n):n.end(),n}};async function S(e){let t=e.headers["content-type"]||"";return new Promise((n,r)=>{let o=[];e.on("data",s=>{o.push(s)}),e.on("end",()=>{let s=Buffer.concat(o).toString("utf-8");if(!s){n(void 0);return}try{t.includes("application/json")?n(JSON.parse(s)):t.includes("application/x-www-form-urlencoded")?n(Object.fromEntries(new URLSearchParams(s))):n(s)}catch{n(s)}}),e.on("error",r)})}async function x(e,t){let n=e.getReader();try{for(;;){let{done:r,value:o}=await n.read();if(r)break;await new Promise((s,i)=>{t.write(o,a=>{a?i(a):s()})})}}finally{t.end()}}function j(e){let t=d(f,e);return async(n,r,o)=>{try{await t(n,r)}catch{o?o():(r.statusCode=500,r.end("internal server error"))}}}function R(e){let t=d(f,e);return async(n,r)=>{try{await t(n,r)}catch(o){console.error("[tooey/server] request error:",o),r.statusCode=500,r.setHeader("Content-Type","text/plain"),r.end("internal server error")}}}async function M(e,t={}){let{createServer:n}=await import("http"),r=t.port??3e3,o=t.host||"localhost",s=R(e);return new Promise(i=>{let a=n(s);a.listen(r,o,()=>{let p=a.address(),u=typeof p=="object"&&p?p.port:r,c=`http://${o}:${u}`;console.log(`[tooey/server] listening on ${c}`),i({url:c,close:()=>new Promise((w,h)=>{a.close(m=>{m?h(m):w()})})})})})}0&&(module.exports={createHandler,createHttpHandler,createMiddleware,nodeAdapter,serve});
//# sourceMappingURL=node.js.map
