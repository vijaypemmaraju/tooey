function d(e,n){return async(t,r)=>{let o=await e.toRequest(t),s=await n(o);return e.toResponse(s,r)}}var m={name:"node",async toRequest(e){let n=e,t=n.url||"/",r=n.method||"GET",o={};for(let[p,i]of Object.entries(n.headers))typeof i=="string"?o[p.toLowerCase()]=i:Array.isArray(i)&&(o[p.toLowerCase()]=i.join(", "));let s;["POST","PUT","PATCH"].includes(r)&&(s=await f(n));let c=n.socket?.encrypted?"https":"http",a=o.host||"localhost";return{url:`${c}://${a}${t}`,method:r,headers:o,body:s}},toResponse(e,n){let t=n;t.statusCode=e.status;for(let[r,o]of Object.entries(e.headers))t.setHeader(r,o);return typeof e.body=="string"?t.end(e.body):e.body instanceof ReadableStream?y(e.body,t):t.end(),t}};async function f(e){let n=e.headers["content-type"]||"";return new Promise((t,r)=>{let o=[];e.on("data",s=>{o.push(s)}),e.on("end",()=>{let s=Buffer.concat(o).toString("utf-8");if(!s){t(void 0);return}try{n.includes("application/json")?t(JSON.parse(s)):n.includes("application/x-www-form-urlencoded")?t(Object.fromEntries(new URLSearchParams(s))):t(s)}catch{t(s)}}),e.on("error",r)})}async function y(e,n){let t=e.getReader();try{for(;;){let{done:r,value:o}=await t.read();if(r)break;await new Promise((s,c)=>{n.write(o,a=>{a?c(a):s()})})}}finally{n.end()}}function g(e){let n=d(m,e);return async(t,r,o)=>{try{await n(t,r)}catch{o?o():(r.statusCode=500,r.end("internal server error"))}}}function R(e){let n=d(m,e);return async(t,r)=>{try{await n(t,r)}catch(o){console.error("[tooey/server] request error:",o),r.statusCode=500,r.setHeader("Content-Type","text/plain"),r.end("internal server error")}}}async function q(e,n={}){let{createServer:t}=await import("http"),r=n.port||3e3,o=n.host||"localhost",s=R(e);return new Promise(c=>{let a=t(s);a.listen(r,o,()=>{let u=`http://${o}:${r}`;console.log(`[tooey/server] listening on ${u}`),c({url:u,close:()=>new Promise((p,i)=>{a.close(l=>{l?i(l):p()})})})})})}export{d as createHandler,R as createHttpHandler,g as createMiddleware,m as nodeAdapter,q as serve};
//# sourceMappingURL=node.esm.js.map
