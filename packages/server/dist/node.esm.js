function u(e,n){return async(t,o)=>{let r=await e.toRequest(t),s=await n(r);return e.toResponse(s,o)}}var f={name:"node",async toRequest(e){let n=e,t=n.url||"/",o=n.method||"GET",r={};for(let[p,c]of Object.entries(n.headers))typeof c=="string"?r[p.toLowerCase()]=c:Array.isArray(c)&&(r[p.toLowerCase()]=c.join(", "));let s;["POST","PUT","PATCH"].includes(o)&&(s=await R(n));let i=n.socket?.encrypted?"https":"http",a=r.host||"localhost";return{url:`${i}://${a}${t}`,method:o,headers:r,body:s}},toResponse(e,n){let t=n;t.statusCode=e.status;for(let[o,r]of Object.entries(e.headers))t.setHeader(o,r);return typeof e.body=="string"?t.end(e.body):e.body instanceof ReadableStream?w(e.body,t):t.end(),t}};async function R(e){let n=e.headers["content-type"]||"";return new Promise((t,o)=>{let r=[];e.on("data",s=>{r.push(s)}),e.on("end",()=>{let s=Buffer.concat(r).toString("utf-8");if(!s){t(void 0);return}try{n.includes("application/json")?t(JSON.parse(s)):n.includes("application/x-www-form-urlencoded")?t(Object.fromEntries(new URLSearchParams(s))):t(s)}catch{t(s)}}),e.on("error",o)})}async function w(e,n){let t=e.getReader();try{for(;;){let{done:o,value:r}=await t.read();if(o)break;await new Promise((s,i)=>{n.write(r,a=>{a?i(a):s()})})}}finally{n.end()}}function A(e){let n=u(f,e);return async(t,o,r)=>{try{await n(t,o)}catch{r?r():(o.statusCode=500,o.end("internal server error"))}}}function h(e){let n=u(f,e);return async(t,o)=>{try{await n(t,o)}catch(r){console.error("[tooey/server] request error:",r),o.statusCode=500,o.setHeader("Content-Type","text/plain"),o.end("internal server error")}}}async function v(e,n={}){let{createServer:t}=await import("http"),o=n.port??3e3,r=n.host||"localhost",s=h(e);return new Promise(i=>{let a=t(s);a.listen(o,r,()=>{let d=a.address(),p=typeof d=="object"&&d?d.port:o,c=`http://${r}:${p}`;console.log(`[tooey/server] listening on ${c}`),i({url:c,close:()=>new Promise((m,y)=>{a.close(l=>{l?y(l):m()})})})})})}export{u as createHandler,h as createHttpHandler,A as createMiddleware,f as nodeAdapter,v as serve};
//# sourceMappingURL=node.esm.js.map
